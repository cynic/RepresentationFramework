module FinalEquation.Words

module Internal =
    // copied from Helpers.fs in Analysis project
    // constraintForms relies upon functions in SHA1.MessageExpansion.Reversal
    //let constraintForms = [|0..79|] |> Array.map (expansionForm >> constraintForm) // this is with reference to wn.0
    let constraintForms = // pre-calculated, and spat out using something like constraintForms |> Array.iter (fun xs -> printf "[|";xs |> Array.iter (fun {Position=p;Index=i} -> printf "{Position=%d; Index=%d}; " p i); printfn "|]");;
        [|
            [|0,0;|]
            [|1,0;|]
            [|2,0;|]
            [|3,0;|]
            [|4,0;|]
            [|5,0;|]
            [|6,0;|]
            [|7,0;|]
            [|8,0;|]
            [|9,0;|]
            [|10,0;|]
            [|11,0;|]
            [|12,0;|]
            [|13,0;|]
            [|14,0;|]
            [|15,0;|]
            [|0,1;2,1;8,1;13,1;|]
            [|1,1;3,1;9,1;14,1;|]
            [|2,1;4,1;10,1;15,1;|]
            [|0,2;2,2;3,1;5,1;8,2;11,1;13,2;|]
            [|1,2;3,2;4,1;6,1;9,2;12,1;14,2;|]
            [|2,2;4,2;5,1;7,1;10,2;13,1;15,2;|]
            [|0,3;2,3;3,2;5,2;6,1;8,1;8,3;11,2;13,3;14,1;|]
            [|1,3;3,3;4,2;6,2;7,1;9,1;9,3;12,2;14,3;15,1;|]
            [|0,2;2,2;2,3;4,3;5,2;7,2;8,1;8,2;10,1;10,3;15,3;|]
            [|0,4;1,2;2,4;3,2;3,3;5,3;6,2;8,2;8,4;9,1;9,2;11,1;11,3;13,4;|]
            [|1,4;2,2;3,4;4,2;4,3;6,3;7,2;9,2;9,4;10,1;10,2;12,1;12,3;14,4;|]
            [|2,4;3,2;4,4;5,2;5,3;7,3;8,2;10,2;10,4;11,1;11,2;13,1;13,3;15,4;|]
            [|0,5;2,5;3,4;4,2;5,4;6,2;6,3;8,3;8,5;9,2;11,2;11,4;12,1;12,2;13,5;14,1;14,3;|]
            [|1,5;3,5;4,4;5,2;6,4;7,2;7,3;9,3;9,5;10,2;12,2;12,4;13,1;13,2;14,5;15,1;15,3;|]
            [|0,2;0,4;2,2;2,4;2,5;4,5;5,4;6,2;7,4;8,3;8,4;10,3;10,5;11,2;14,1;14,2;15,5;|]
            [|0,6;1,2;1,4;2,6;3,2;3,4;3,5;5,5;6,4;7,2;8,4;8,6;9,3;9,4;11,3;11,5;12,2;13,6;15,1;15,2;|]
            [|0,2;0,3;1,6;2,3;2,4;3,6;4,2;4,4;4,5;6,5;7,4;8,3;9,4;9,6;10,3;10,4;12,3;12,5;13,3;14,6;|]
            [|1,2;1,3;2,6;3,3;3,4;4,6;5,2;5,4;5,5;7,5;8,4;9,3;10,4;10,6;11,3;11,4;13,3;13,5;14,3;15,6;|]
            [|0,7;2,2;2,3;2,7;3,6;4,3;4,4;5,6;6,2;6,4;6,5;8,5;8,7;9,4;10,3;11,4;11,6;12,3;12,4;13,7;14,3;14,5;15,3;|]
            [|0,4;1,7;2,4;3,2;3,3;3,7;4,6;5,3;5,4;6,6;7,2;7,4;7,5;8,4;9,5;9,7;10,4;11,3;12,4;12,6;13,3;14,7;15,3;15,5;|]
            [|0,4;0,6;1,4;2,4;2,6;2,7;3,4;4,2;4,3;4,7;5,6;6,3;6,4;7,6;8,2;8,5;8,6;9,4;10,5;10,7;11,4;12,3;14,3;15,7;|]
            [|0,8;1,4;1,6;2,4;2,8;3,4;3,6;3,7;4,4;5,2;5,3;5,7;6,6;7,3;7,4;8,6;8,8;9,2;9,5;9,6;10,4;11,5;11,7;12,4;13,3;13,8;15,3;|]
            [|0,4;1,8;2,6;3,4;3,8;4,4;4,6;4,7;5,4;6,2;6,3;6,7;7,6;8,3;9,6;9,8;10,2;10,5;10,6;11,4;12,5;12,7;14,3;14,8;|]
            [|1,4;2,8;3,6;4,4;4,8;5,4;5,6;5,7;6,4;7,2;7,3;7,7;8,6;9,3;10,6;10,8;11,2;11,5;11,6;12,4;13,5;13,7;15,3;15,8;|]
            [|0,4;0,9;2,9;3,8;4,6;5,4;5,8;6,4;6,6;6,7;7,4;8,2;8,3;8,4;8,7;8,9;9,6;10,3;11,6;11,8;12,2;12,5;12,6;13,9;14,5;14,7;|]
            [|1,4;1,9;3,9;4,8;5,6;6,4;6,8;7,4;7,6;7,7;8,4;9,2;9,3;9,4;9,7;9,9;10,6;11,3;12,6;12,8;13,2;13,5;13,6;14,9;15,5;15,7;|]
            [|0,6;0,8;2,4;2,6;2,8;2,9;4,9;5,8;6,6;7,4;7,8;8,4;8,7;8,8;9,4;10,2;10,3;10,4;10,7;10,9;11,6;12,3;14,2;14,5;14,6;15,9;|]
            [|0,10;1,6;1,8;2,10;3,4;3,6;3,8;3,9;5,9;6,8;7,6;8,4;8,8;8,10;9,4;9,7;9,8;10,4;11,2;11,3;11,4;11,7;11,9;12,6;13,3;13,10;15,2;15,5;15,6;|]
            [|0,3;0,6;0,7;1,10;2,3;2,7;2,8;3,10;4,4;4,6;4,8;4,9;6,9;7,8;8,3;8,7;9,4;9,8;9,10;10,4;10,7;10,8;11,4;12,2;12,3;12,4;12,7;12,9;13,3;13,7;14,3;14,10;|]
            [|1,3;1,6;1,7;2,10;3,3;3,7;3,8;4,10;5,4;5,6;5,8;5,9;7,9;8,8;9,3;9,7;10,4;10,8;10,10;11,4;11,7;11,8;12,4;13,2;13,3;13,4;13,7;13,9;14,3;14,7;15,3;15,10;|]
            [|0,4;0,11;2,3;2,4;2,6;2,7;2,11;3,10;4,3;4,7;4,8;5,10;6,4;6,6;6,8;6,9;8,4;8,9;8,11;9,8;10,3;10,7;11,4;11,8;11,10;12,4;12,7;12,8;13,11;14,2;14,3;14,4;14,7;14,9;15,3;15,7;|]
            [|0,4;0,8;1,4;1,11;2,4;2,8;3,3;3,4;3,6;3,7;3,11;4,10;5,3;5,7;5,8;6,10;7,4;7,6;7,8;7,9;8,4;8,8;9,4;9,9;9,11;10,8;11,3;11,7;12,4;12,8;12,10;13,7;14,11;15,2;15,3;15,4;15,7;15,9;|]
            [|0,3;0,4;0,5;0,8;0,10;1,4;1,8;2,3;2,5;2,8;2,10;2,11;3,4;3,8;4,3;4,4;4,6;4,7;4,11;5,10;6,3;6,7;6,8;7,10;8,3;8,5;8,6;8,9;8,10;9,4;9,8;10,4;10,9;10,11;11,8;12,3;12,7;13,3;13,5;14,7;15,11;|]
            [|0,12;1,3;1,4;1,5;1,8;1,10;2,4;2,8;2,12;3,3;3,5;3,8;3,10;3,11;4,4;4,8;5,3;5,4;5,6;5,7;5,11;6,10;7,3;7,7;7,8;8,10;8,12;9,3;9,5;9,6;9,9;9,10;10,4;10,8;11,4;11,9;11,11;12,8;13,3;13,7;13,12;14,3;14,5;15,7;|]
            [|0,8;1,12;2,3;2,4;2,5;2,10;3,4;3,8;3,12;4,3;4,5;4,8;4,10;4,11;5,4;5,8;6,3;6,4;6,6;6,7;6,11;7,10;8,3;8,7;9,10;9,12;10,3;10,5;10,6;10,9;10,10;11,4;11,8;12,4;12,9;12,11;14,3;14,7;14,12;15,3;15,5;|]
            [|0,4;0,6;1,8;2,4;2,6;2,12;3,3;3,4;3,5;3,10;4,4;4,8;4,12;5,3;5,5;5,8;5,10;5,11;6,4;6,8;7,3;7,4;7,6;7,7;7,11;8,4;8,6;8,10;9,3;9,7;10,10;10,12;11,3;11,5;11,6;11,9;11,10;12,4;12,8;13,6;13,9;13,11;15,3;15,7;15,12;|]
            [|0,4;0,8;0,13;1,4;1,6;2,4;2,13;3,4;3,6;3,12;4,3;4,4;4,5;4,10;5,4;5,8;5,12;6,3;6,5;6,8;6,10;6,11;7,4;7,8;8,3;8,6;8,7;8,8;8,11;8,13;9,4;9,6;9,10;10,3;10,7;11,10;11,12;12,3;12,5;12,6;12,9;12,10;13,13;14,6;14,9;14,11;|]
            [|1,4;1,8;1,13;2,4;2,6;3,4;3,13;4,4;4,6;4,12;5,3;5,4;5,5;5,10;6,4;6,8;6,12;7,3;7,5;7,8;7,10;7,11;8,4;8,8;9,3;9,6;9,7;9,8;9,11;9,13;10,4;10,6;10,10;11,3;11,7;12,10;12,12;13,3;13,5;13,6;13,9;13,10;14,13;15,6;15,9;15,11;|]
            [|0,7;0,10;0,12;2,4;2,7;2,8;2,10;2,12;2,13;3,4;3,6;4,4;4,13;5,4;5,6;5,12;6,3;6,4;6,5;6,10;7,4;7,8;7,12;8,3;8,5;8,7;8,8;8,11;8,12;9,4;9,8;10,3;10,6;10,7;10,8;10,11;10,13;11,4;11,6;11,10;12,3;12,7;13,7;14,3;14,5;14,6;14,9;14,10;15,13;|]
            [|0,14;1,7;1,10;1,12;2,14;3,4;3,7;3,8;3,10;3,12;3,13;4,4;4,6;5,4;5,13;6,4;6,6;6,12;7,3;7,4;7,5;7,10;8,4;8,8;8,12;8,14;9,3;9,5;9,7;9,8;9,11;9,12;10,4;10,8;11,3;11,6;11,7;11,8;11,11;11,13;12,4;12,6;12,10;13,3;13,7;13,14;14,7;15,3;15,5;15,6;15,9;15,10;|]
            [|0,4;0,6;0,7;0,10;0,11;1,14;2,4;2,6;2,11;2,12;3,14;4,4;4,7;4,8;4,10;4,12;4,13;5,4;5,6;6,4;6,13;7,4;7,6;7,12;8,3;8,5;8,6;8,7;8,11;9,4;9,8;9,12;9,14;10,3;10,5;10,7;10,8;10,11;10,12;11,4;11,8;12,3;12,6;12,7;12,8;12,11;12,13;13,7;13,11;14,3;14,7;14,14;15,7;|]
            [|0,8;1,4;1,6;1,7;1,10;1,11;2,8;2,14;3,4;3,6;3,11;3,12;4,14;5,4;5,7;5,8;5,10;5,12;5,13;6,4;6,6;7,4;7,13;8,4;8,6;8,8;8,12;9,3;9,5;9,6;9,7;9,11;10,4;10,8;10,12;10,14;11,3;11,5;11,7;11,8;11,11;11,12;12,4;12,8;13,3;13,6;13,7;13,11;13,13;14,7;14,11;15,3;15,7;15,14;|]
            [|0,4;0,8;0,15;1,8;2,6;2,7;2,8;2,10;2,11;2,15;3,8;3,14;4,4;4,6;4,11;4,12;5,14;6,4;6,7;6,8;6,10;6,12;6,13;7,4;7,6;8,8;8,13;8,15;9,4;9,6;9,8;9,12;10,3;10,5;10,6;10,7;10,11;11,4;11,8;11,12;11,14;12,3;12,5;12,7;12,8;12,11;12,12;13,15;14,3;14,6;14,7;14,11;14,13;15,7;15,11;|]
            [|0,8;0,12;1,4;1,8;1,15;2,12;3,6;3,7;3,8;3,10;3,11;3,15;4,8;4,14;5,4;5,6;5,11;5,12;6,14;7,4;7,7;7,8;7,10;7,12;7,13;8,4;8,6;8,8;8,12;9,8;9,13;9,15;10,4;10,6;10,8;10,12;11,3;11,5;11,6;11,7;11,11;12,4;12,8;12,12;12,14;13,3;13,5;13,7;13,11;14,15;15,3;15,6;15,7;15,11;15,13;|]
            [|0,4;0,7;0,8;0,12;0,14;1,8;1,12;2,7;2,12;2,14;2,15;3,12;4,6;4,7;4,8;4,10;4,11;4,15;5,8;5,14;6,4;6,6;6,11;6,12;7,14;8,10;8,13;8,14;9,4;9,6;9,8;9,12;10,8;10,13;10,15;11,4;11,6;11,8;11,12;12,3;12,5;12,6;12,7;12,11;13,7;14,3;14,5;14,7;14,11;15,15;|]
            [|0,16;1,4;1,7;1,8;1,12;1,14;2,8;2,12;2,16;3,7;3,12;3,14;3,15;4,12;5,6;5,7;5,8;5,10;5,11;5,15;6,8;6,14;7,4;7,6;7,11;7,12;8,14;8,16;9,10;9,13;9,14;10,4;10,6;10,8;10,12;11,8;11,13;11,15;12,4;12,6;12,8;12,12;13,3;13,5;13,6;13,7;13,11;13,16;14,7;15,3;15,5;15,7;15,11;|]
            [|0,4;0,6;0,8;0,12;1,16;2,6;2,7;2,14;3,8;3,12;3,16;4,7;4,12;4,14;4,15;5,12;6,6;6,7;6,8;6,10;6,11;6,15;7,8;7,14;8,8;8,11;9,14;9,16;10,10;10,13;10,14;11,4;11,6;11,8;11,12;12,8;12,13;12,15;14,3;14,5;14,6;14,7;14,11;14,16;15,7;|]
            [|0,8;1,4;1,6;1,8;1,12;2,8;2,16;3,6;3,7;3,14;4,8;4,12;4,16;5,7;5,12;5,14;5,15;6,12;7,6;7,7;7,8;7,10;7,11;7,15;8,14;9,8;9,11;10,14;10,16;11,10;11,13;11,14;12,4;12,6;12,8;12,12;13,13;13,15;15,3;15,5;15,6;15,7;15,11;15,16;|]
            [|0,4;0,6;0,7;0,8;0,12;0,17;1,8;2,7;2,17;3,8;3,16;4,6;4,7;4,14;5,8;5,12;5,16;6,7;6,12;6,14;6,15;7,12;8,4;8,10;8,11;8,12;8,15;8,17;9,14;10,8;10,11;11,14;11,16;12,10;12,13;12,14;13,7;13,17;14,13;14,15;|]
            [|1,4;1,6;1,7;1,8;1,12;1,17;2,8;3,7;3,17;4,8;4,16;5,6;5,7;5,14;6,8;6,12;6,16;7,7;7,12;7,14;7,15;8,12;9,4;9,10;9,11;9,12;9,15;9,17;10,14;11,8;11,11;12,14;12,16;13,10;13,13;13,14;14,7;14,17;15,13;15,15;|]
            [|0,14;0,16;2,4;2,6;2,7;2,8;2,12;2,14;2,16;2,17;3,8;4,7;4,17;5,8;5,16;6,6;6,7;6,14;7,8;7,12;7,16;8,7;8,12;8,15;8,16;9,12;10,4;10,10;10,11;10,12;10,15;10,17;11,14;12,8;12,11;14,10;14,13;14,14;15,7;15,17;|]
            [|0,8;0,18;1,14;1,16;2,8;2,18;3,4;3,6;3,7;3,8;3,12;3,14;3,16;3,17;4,8;5,7;5,17;6,8;6,16;7,6;7,7;7,14;8,12;8,16;8,18;9,7;9,12;9,15;9,16;10,12;11,4;11,10;11,11;11,12;11,15;11,17;12,14;13,11;13,18;15,10;15,13;15,14;|]
            [|0,11;0,14;0,15;1,8;1,18;2,11;2,15;2,16;3,8;3,18;4,4;4,6;4,7;4,8;4,12;4,14;4,16;4,17;5,8;6,7;6,17;7,8;7,16;8,6;8,7;8,11;8,15;9,12;9,16;9,18;10,7;10,12;10,15;10,16;11,12;12,4;12,10;12,11;12,12;12,15;12,17;13,11;13,15;14,11;14,18;|]
            [|1,11;1,14;1,15;2,8;2,18;3,11;3,15;3,16;4,8;4,18;5,4;5,6;5,7;5,8;5,12;5,14;5,16;5,17;6,8;7,7;7,17;8,8;8,16;9,6;9,7;9,11;9,15;10,12;10,16;10,18;11,7;11,12;11,15;11,16;12,12;13,4;13,10;13,11;13,12;13,15;13,17;14,11;14,15;15,11;15,18;|]
            [|0,12;0,19;2,11;2,12;2,14;2,15;2,19;3,8;3,18;4,11;4,15;4,16;5,8;5,18;6,4;6,6;6,7;6,8;6,12;6,14;6,16;6,17;7,8;8,7;8,12;8,17;8,19;9,8;9,16;10,6;10,7;10,11;10,15;11,12;11,16;11,18;12,7;12,12;12,15;12,16;13,19;14,4;14,10;14,11;14,12;14,15;14,17;15,11;15,15;|]
            [|0,12;0,16;1,12;1,19;2,12;2,16;3,11;3,12;3,14;3,15;3,19;4,8;4,18;5,11;5,15;5,16;6,8;6,18;7,4;7,6;7,7;7,8;7,12;7,14;7,16;7,17;8,8;8,12;8,16;9,7;9,12;9,17;9,19;10,8;10,16;11,6;11,7;11,11;11,15;12,12;12,16;12,18;13,7;13,15;14,19;15,4;15,10;15,11;15,12;15,15;15,17;|]
            [|0,5;0,11;0,12;0,13;0,16;0,18;1,12;1,16;2,5;2,11;2,13;2,16;2,18;2,19;3,12;3,16;4,11;4,12;4,14;4,15;4,19;5,8;5,18;6,11;6,15;6,16;7,8;7,18;8,4;8,5;8,6;8,7;8,8;8,11;8,13;8,14;8,17;8,18;9,8;9,12;9,16;10,7;10,12;10,17;10,19;11,8;11,16;12,6;12,7;12,11;12,15;13,5;13,11;13,13;14,7;14,15;15,19;|]
            [|0,20;1,5;1,11;1,12;1,13;1,16;1,18;2,12;2,16;2,20;3,5;3,11;3,13;3,16;3,18;3,19;4,12;4,16;5,11;5,12;5,14;5,15;5,19;6,8;6,18;7,11;7,15;7,16;8,8;8,18;8,20;9,4;9,5;9,6;9,7;9,8;9,11;9,13;9,14;9,17;9,18;10,8;10,12;10,16;11,7;11,12;11,17;11,19;12,8;12,16;13,6;13,7;13,11;13,15;13,20;14,5;14,11;14,13;15,7;15,15;|]
            [|0,8;0,16;1,20;2,5;2,8;2,11;2,12;2,13;2,18;3,12;3,16;3,20;4,5;4,11;4,13;4,16;4,18;4,19;5,12;5,16;6,11;6,12;6,14;6,15;6,19;7,8;7,18;8,8;8,11;8,15;9,8;9,18;9,20;10,4;10,5;10,6;10,7;10,8;10,11;10,13;10,14;10,17;10,18;11,8;11,12;11,16;12,7;12,12;12,17;12,19;14,6;14,7;14,11;14,15;14,20;15,5;15,11;15,13;|]
            [|0,6;0,12;0,14;1,8;1,16;2,6;2,12;2,14;2,20;3,5;3,8;3,11;3,12;3,13;3,18;4,12;4,16;4,20;5,5;5,11;5,13;5,16;5,18;5,19;6,12;6,16;7,11;7,12;7,14;7,15;7,19;8,6;8,8;8,12;8,14;8,18;9,8;9,11;9,15;10,8;10,18;10,20;11,4;11,5;11,6;11,7;11,8;11,11;11,13;11,14;11,17;11,18;12,8;12,12;12,16;13,6;13,7;13,14;13,17;13,19;15,6;15,7;15,11;15,15;15,20;|]
            [|0,7;0,8;0,12;0,16;0,21;1,6;1,12;1,14;2,7;2,12;2,21;3,6;3,12;3,14;3,20;4,5;4,8;4,11;4,12;4,13;4,18;5,12;5,16;5,20;6,5;6,11;6,13;6,16;6,18;6,19;7,12;7,16;8,7;8,8;8,11;8,14;8,15;8,16;8,19;8,21;9,6;9,8;9,12;9,14;9,18;10,8;10,11;10,15;11,8;11,18;11,20;12,4;12,5;12,6;12,7;12,8;12,11;12,13;12,14;12,17;12,18;13,7;13,21;14,6;14,7;14,14;14,17;14,19;|]
            [|1,7;1,8;1,12;1,16;1,21;2,6;2,12;2,14;3,7;3,12;3,21;4,6;4,12;4,14;4,20;5,5;5,8;5,11;5,12;5,13;5,18;6,12;6,16;6,20;7,5;7,11;7,13;7,16;7,18;7,19;8,12;8,16;9,7;9,8;9,11;9,14;9,15;9,16;9,19;9,21;10,6;10,8;10,12;10,14;10,18;11,8;11,11;11,15;12,8;12,18;12,20;13,4;13,5;13,6;13,7;13,8;13,11;13,13;13,14;13,17;13,18;14,7;14,21;15,6;15,7;15,14;15,17;15,19;|]
            [|0,7;0,8;0,15;0,18;0,20;2,12;2,15;2,16;2,18;2,20;2,21;3,6;3,12;3,14;4,7;4,12;4,21;5,6;5,12;5,14;5,20;6,5;6,8;6,11;6,12;6,13;6,18;7,12;7,16;7,20;8,5;8,7;8,8;8,11;8,13;8,15;8,16;8,19;8,20;9,12;9,16;10,7;10,8;10,11;10,14;10,15;10,16;10,19;10,21;11,6;11,8;11,12;11,14;11,18;12,8;12,11;12,15;13,7;13,15;14,4;14,5;14,6;14,7;14,8;14,11;14,13;14,14;14,17;14,18;15,7;15,21;|]
            [|0,8;0,22;1,7;1,8;1,15;1,18;1,20;2,8;2,22;3,12;3,15;3,16;3,18;3,20;3,21;4,6;4,12;4,14;5,7;5,12;5,21;6,6;6,12;6,14;6,20;7,5;7,8;7,11;7,12;7,13;7,18;8,8;8,12;8,16;8,20;8,22;9,5;9,7;9,8;9,11;9,13;9,15;9,16;9,19;9,20;10,12;10,16;11,7;11,8;11,11;11,14;11,15;11,16;11,19;11,21;12,6;12,8;12,12;12,14;12,18;13,11;13,15;13,22;14,7;14,15;15,4;15,5;15,6;15,7;15,8;15,11;15,13;15,14;15,17;15,18;|]
        |]


open FinalEquation.CommonStructure

/// which data-word bits have a chance of affecting wn.idx?
let can_affect n idx =
    Internal.constraintForms.[n]
    |> Array.map (fun (p,i) -> p * 32 + ((i+idx)%32)) // this is with reference to wn.idx

let constantValue (dwlen : uint32) n =
    if n < int dwlen || n > 511 then failwithf "%d is not a constant value (dwlen=%d)" n dwlen
    elif n = int dwlen then true
    elif n > int dwlen && n <= (512-16) then false
    else dwlen.[n-480]

let init_words dwlen (repr : ICalculator<_>) (storage : IStorage<_>) =
    let lenBits = (uint32 dwlen).Bits |> Seq.toArray
    for i = 0 to 511 do
        let key = { Round=i/32; Bit=i%32; Var=V.W }
        if not <| storage.Exists key then // got to do this now, because it's too late ...
            let _i = uint32 i
            let result =
                if _i < dwlen then repr.MakeVariable _i // ... by the time that I reach here!
                elif _i = dwlen then repr.Constants.One
                elif i >= 480 then
                    if lenBits.[i-480] then repr.Constants.One
                    else repr.Constants.Zero
                else repr.Constants.Zero
            storage.Store key result

type Traditional<'T>(dwlen : uint32, repr : ICalculator<'T>, storage : IStorage<'T>) =
    do init_words dwlen repr storage

    let rec w (w_key : Designator) =
        assert (w_key.Round >= 0)
        storage.GetOrGenerate w_key (fun _ ->
            let r, i = w_key.PI
            let ofs3, ofs8, ofs14, ofs16 = 
                let ofs3 = storage.GetOrGenerate ({ Round=r - 3; Bit=(i + 1) % 32; Var=V.W }) w
                let ofs8 = storage.GetOrGenerate ({ Round=r - 8; Bit=(i + 1) % 32; Var=V.W }) w
                let ofs14 = storage.GetOrGenerate ({ Round=r - 14; Bit=(i + 1) % 32; Var=V.W }) w
                let ofs16 = storage.GetOrGenerate ({ Round=r - 16; Bit=(i + 1) % 32; Var=V.W }) w
                ofs3, ofs8, ofs14, ofs16
        
            let _0 = repr.Xor ofs3 ofs8
            let _1 = repr.Xor ofs14 ofs16
            let out = repr.Xor _0 _1
            //printfn "TradW (%d,%d) => %O" r i out
            out
        )

    override __.ToString () = sprintf "TraditionalW%03d" dwlen

    interface IWords<'T> with
        member __.Word (k) = w k
        member __.Word (r,i) = w ({ Round=r; Bit=i; Var=V.W })
(*
    do // precalculate everything!
        for i = 512 to 2559 do
            let key = { Round=i/32; Bit=i%32; Var=V.W }
            let _i = uint32 i
            let result = w key
            storage.StoreINE key result
*)

type BaseXor<'T>(dwlen : uint32, repr : ICalculator<'T>, storage : IStorage<'T>) =
    do init_words dwlen repr storage

    let w (w_key : Designator) =
        storage.GetOrGenerate w_key (fun _ ->
            let r, i = w_key.PI
            //System.Console.WriteLine("Seeking W @ r={0}, i={1}", r, i)
            if r > 79 then repr.Constants.Zero
            else
                let affected = can_affect r i
                match affected with
                | [||] -> repr.Constants.Zero
                | _ ->
                    affected
                    |> Array.map (fun x ->
                        let key = { Round=x/32; Bit=x%32; Var=V.W }
                        if storage.Exists key then storage.Get key else failwithf "W value %O does not exist, but should exist" key
                    )
                    |> Array.reduce repr.Xor
        )

    override __.ToString () = sprintf "BaseXorW%03d" dwlen

    interface IWords<'T> with
        member __.Word (k) = w k
        member __.Word (r,i) = w ({ Round=r; Bit=i; Var=V.W })
        
type Dummy<'T>() =
    interface IWords<'T> with
        member __.Word _ = failwith "should never be called"
        member __.Word (_,_) = failwith "should never be called"